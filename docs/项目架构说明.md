# 城市智能低空交通系统 - 项目架构说明

## 总体架构概览

城市智能低空交通系统采用现代化的前后端分离架构，通过RESTful API进行数据交互，确保系统的高性能、高可用性和高扩展性。

```
┌─────────────────────────────────────────────────────────────┐
│                     客户端层 (Client Layer)                  │
├─────────────────────────────────────────────────────────────┤
│  Web浏览器 │ 移动端浏览器 │ 桌面应用 │ 第三方应用集成        │
└─────────────────────────────────────────────────────────────┘
                                │
                        HTTPS/WebSocket
                                │
┌─────────────────────────────────────────────────────────────┐
│                     前端层 (Frontend Layer)                  │
├─────────────────────────────────────────────────────────────┤
│                      Vue 3 应用                             │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐   │
│  │ 路由管理     │ 状态管理     │ 组件库      │ 服务层      │   │
│  │ Vue Router  │ Vuex Store  │ Element Plus│ API Services│   │
│  └─────────────┴─────────────┴─────────────┴─────────────┘   │
└─────────────────────────────────────────────────────────────┘
                                │
                          RESTful API
                                │
┌─────────────────────────────────────────────────────────────┐
│                     API网关层 (API Gateway)                  │
├─────────────────────────────────────────────────────────────┤
│  负载均衡 │ API路由 │ 请求限流 │ 跨域处理 │ 安全过滤       │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                     后端层 (Backend Layer)                   │
├─────────────────────────────────────────────────────────────┤
│                      C++ HTTP服务器                          │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐   │
│  │ 控制器层     │ 服务层      │ 数据访问层   │ 工具层      │   │
│  │ Controllers │ Services    │ Repositories│ Utils       │   │
│  └─────────────┴─────────────┴─────────────┴─────────────┘   │
└─────────────────────────────────────────────────────────────┘
                                │
                        MySQL X DevAPI
                                │
┌─────────────────────────────────────────────────────────────┐
│                     数据层 (Data Layer)                      │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐   │
│  │ MySQL数据库  │ Redis缓存   │ 文件存储     │ 日志存储     │   │
│  │ (主数据)     │ (会话/缓存)  │ (静态资源)   │ (系统日志)   │   │
│  └─────────────┴─────────────┴─────────────┴─────────────┘   │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                   外部服务层 (External Services)              │
├─────────────────────────────────────────────────────────────┤
│  高德地图API │ OpenWeather API │ 短信服务 │ 邮件服务         │
└─────────────────────────────────────────────────────────────┘
```

## 前端架构详解

### Vue 3 应用架构

```
src/
├── main.js                    # 应用入口文件
├── App.vue                    # 根组件
├── router/                    # 路由配置
│   ├── index.js              # 主路由配置
│   └── guards.js             # 路由守卫
├── store/                     # Vuex状态管理
│   ├── index.js              # Store入口
│   ├── modules/              # 状态模块
│   │   ├── auth.js           # 认证状态
│   │   ├── user.js           # 用户状态
│   │   ├── map.js            # 地图状态
│   │   └── weather.js        # 天气状态
│   └── plugins/              # Store插件
├── components/               # 可复用组件
│   ├── common/               # 通用组件
│   │   ├── Header.vue
│   │   ├── Sidebar.vue
│   │   └── Footer.vue
│   ├── auth/                 # 认证相关组件
│   │   ├── LoginPage.vue
│   │   ├── RegisterPage.vue
│   │   └── AuthLayout.vue
│   ├── map/                  # 地图相关组件
│   └── weather/              # 天气相关组件
├── views/                    # 页面视图
│   ├── Dashboard.vue         # 主控制台
│   ├── Profile.vue           # 用户资料
│   └── Settings.vue          # 系统设置
├── services/                 # API服务
│   ├── api.js                # API基础配置
│   ├── authApi.js            # 认证API
│   ├── mapApi.js             # 地图API
│   └── weatherApi.js         # 天气API
├── utils/                    # 工具函数
│   ├── request.js            # HTTP请求封装
│   ├── auth.js               # 认证工具
│   └── validators.js         # 表单验证
├── assets/                   # 静态资源
│   ├── styles/               # 样式文件
│   ├── images/               # 图片资源
│   └── fonts/                # 字体文件
└── plugins/                  # Vue插件
    ├── element-plus.js       # Element Plus配置
    └── echarts.js            # ECharts配置
```

### 前端数据流

```
用户操作 → Vue组件 → Action → Mutation → State → Vue组件更新
    ↓
API服务 ← HTTP请求 ← Action中的异步操作
    ↓
后端API响应 → Action完成 → Mutation更新状态 → 界面更新
```

## 后端架构详解

### C++ 服务器架构

```
backend/
├── src/                      # 源代码目录
│   ├── main.cpp              # 程序入口
│   ├── server.h/.cpp         # HTTP服务器
│   ├── controllers/          # 控制器层
│   │   ├── AuthController.h/.cpp     # 认证控制器
│   │   ├── UserController.h/.cpp     # 用户控制器
│   │   ├── MapController.h/.cpp      # 地图控制器
│   │   └── WeatherController.h/.cpp  # 天气控制器
│   ├── services/             # 业务逻辑层
│   │   ├── AuthService.h/.cpp        # 认证服务
│   │   ├── UserService.h/.cpp        # 用户服务
│   │   ├── JwtService.h/.cpp         # JWT服务
│   │   └── EmailService.h/.cpp       # 邮件服务
│   ├── repositories/         # 数据访问层
│   │   ├── UserRepository.h/.cpp     # 用户数据访问
│   │   ├── TokenRepository.h/.cpp    # Token数据访问
│   │   └── LogRepository.h/.cpp      # 日志数据访问
│   ├── models/               # 数据模型
│   │   ├── User.h/.cpp               # 用户模型
│   │   ├── Token.h/.cpp              # Token模型
│   │   └── Response.h/.cpp           # 响应模型
│   ├── middleware/           # 中间件
│   │   ├── AuthMiddleware.h/.cpp     # 认证中间件
│   │   ├── CorsMiddleware.h/.cpp     # CORS中间件
│   │   └── LoggingMiddleware.h/.cpp  # 日志中间件
│   ├── utils/                # 工具类
│   │   ├── HttpResponse.h/.cpp       # HTTP响应工具
│   │   ├── StringUtils.h/.cpp        # 字符串工具
│   │   ├── DateUtils.h/.cpp          # 日期工具
│   │   └── CryptoUtils.h/.cpp        # 加密工具
│   └── config/               # 配置管理
│       ├── DatabaseConfig.h/.cpp     # 数据库配置
│       ├── ServerConfig.h/.cpp       # 服务器配置
│       └── AppConfig.h/.cpp          # 应用配置
├── tests/                    # 测试文件
│   ├── test_jwt_service.cpp          # JWT服务测试
│   ├── test_auth_controller.cpp      # 认证控制器测试
│   └── test_user_repository.cpp      # 用户仓储测试
├── config/                   # 配置文件
│   ├── server.json           # 服务器配置
│   └── database.h            # 数据库配置
├── build/                    # 构建输出
├── CMakeLists.txt            # 构建配置
└── vcpkg.json                # 依赖管理
```

### 请求处理流程

```
HTTP请求 → 路由分发 → 中间件链 → 控制器 → 服务层 → 数据访问层 → 数据库
    ↓
HTTP响应 ← JSON序列化 ← 响应构造 ← 业务处理 ← 数据处理 ← SQL执行 ← 数据库响应
```

## 数据库设计

### 主要数据表结构

```sql
-- 用户表
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    full_name VARCHAR(100),
    role ENUM('admin', 'operator', 'user') DEFAULT 'user',
    status ENUM('active', 'inactive', 'locked') DEFAULT 'active',
    failed_login_count INT DEFAULT 0,
    last_login_at TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 刷新令牌表
CREATE TABLE refresh_tokens (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    token_hash VARCHAR(255) NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    is_revoked BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 飞行任务表
CREATE TABLE flight_tasks (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    task_name VARCHAR(200) NOT NULL,
    description TEXT,
    start_location JSON NOT NULL,
    end_location JSON NOT NULL,
    waypoints JSON,
    status ENUM('planned', 'approved', 'executing', 'completed', 'cancelled') DEFAULT 'planned',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 设备管理表
CREATE TABLE devices (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    device_name VARCHAR(100) NOT NULL,
    device_type ENUM('drone', 'vtol', 'helicopter') NOT NULL,
    serial_number VARCHAR(100) UNIQUE,
    status ENUM('online', 'offline', 'maintenance') DEFAULT 'offline',
    current_location JSON,
    last_heartbeat TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

### 数据库连接架构

```
应用层 (Repository)
         ↓
    连接池管理
         ↓
   MySQL X DevAPI
         ↓
    MySQL 8.0 服务器
         ↓
    InnoDB 存储引擎
```

## API接口设计

### RESTful API规范

```
基础URL: http://localhost:8080/api/v1

认证相关:
POST   /auth/register          # 用户注册
POST   /auth/login             # 用户登录
POST   /auth/refresh           # 刷新Token
GET    /auth/me                # 获取当前用户信息
PUT    /auth/password          # 修改密码
POST   /auth/logout            # 用户登出

用户管理:
GET    /users                  # 获取用户列表（管理员）
GET    /users/{id}             # 获取指定用户信息
PUT    /users/{id}             # 更新用户信息
DELETE /users/{id}             # 删除用户（管理员）

飞行任务:
GET    /tasks                  # 获取任务列表
POST   /tasks                  # 创建新任务
GET    /tasks/{id}             # 获取任务详情
PUT    /tasks/{id}             # 更新任务
DELETE /tasks/{id}             # 删除任务

设备管理:
GET    /devices                # 获取设备列表
POST   /devices                # 注册新设备
GET    /devices/{id}           # 获取设备详情
PUT    /devices/{id}           # 更新设备信息
DELETE /devices/{id}           # 删除设备

地图服务:
GET    /map/locations          # 获取位置信息
POST   /map/route              # 路径规划
GET    /map/weather            # 天气信息
```

### 响应格式标准

```json
{
  "success": true,
  "message": "操作成功",
  "data": {
    // 具体数据内容
  },
  "timestamp": 1640995200,
  "error_code": null
}
```

## 安全架构

### 认证授权流程

```
用户登录 → 验证凭据 → 生成JWT Token → 返回Token
                                    ↓
后续请求 → 携带Token → 验证Token → 提取用户信息 → 权限检查 → 业务处理
```

### 安全特性

1. **JWT Token安全**
   - HMAC SHA256签名
   - Access Token短期有效（15分钟）
   - Refresh Token长期有效（7天）
   - Token黑名单机制

2. **密码安全**
   - BCrypt哈希算法
   - 密码强度验证
   - 登录失败锁定

3. **传输安全**
   - HTTPS加密传输
   - CORS跨域保护
   - 请求限流防护

4. **数据安全**
   - SQL注入防护（参数化查询）
   - XSS攻击防护
   - 敏感数据加密存储

## 性能优化

### 前端优化

1. **代码分割**
   - 路由级代码分割
   - 组件懒加载
   - 第三方库按需引入

2. **资源优化**
   - 图片压缩和懒加载
   - 静态资源CDN
   - Gzip压缩

3. **缓存策略**
   - 浏览器缓存
   - Service Worker
   - API数据缓存

### 后端优化

1. **数据库优化**
   - 索引优化
   - 查询优化
   - 连接池管理

2. **内存管理**
   - RAII资源管理
   - 对象池复用
   - 内存泄漏检测

3. **并发处理**
   - 异步I/O操作
   - 线程池管理
   - 请求队列优化

## 监控和日志

### 日志架构

```
应用日志 → 日志收集器 → 日志存储 → 日志分析 → 监控告警
    ↓
系统指标 → 指标收集 → 时序数据库 → 可视化面板 → 性能监控
```

### 监控指标

1. **系统指标**
   - CPU使用率
   - 内存使用率
   - 磁盘I/O
   - 网络流量

2. **应用指标**
   - 请求响应时间
   - 错误率统计
   - 并发连接数
   - 数据库查询性能

3. **业务指标**
   - 用户活跃度
   - 接口调用频率
   - 功能使用统计

## 部署架构

### 开发环境

```
开发机 → Git仓库 → CI/CD Pipeline → 测试环境
                        ↓
                   代码质量检查
                        ↓
                   自动化测试
                        ↓
                   构建和打包
```

### 生产环境

```
负载均衡器 (Nginx)
    ↓
前端静态文件服务器
    ↓
后端API服务集群
    ↓
数据库主从架构
    ↓
Redis缓存集群
```

## 扩展性设计

### 水平扩展

1. **前端扩展**
   - CDN分发
   - 多地域部署
   - 缓存策略优化

2. **后端扩展**
   - 微服务架构
   - 容器化部署
   - 自动扩缩容

3. **数据库扩展**
   - 读写分离
   - 分库分表
   - 缓存层优化

### 功能扩展

1. **新功能模块**
   - 插件化架构
   - 模块化设计
   - API版本管理

2. **第三方集成**
   - 开放API标准
   - Webhook机制
   - OAuth认证

## 技术选型说明

### 前端技术选型

| 技术 | 选择理由 |
|------|----------|
| Vue 3 | 现代化框架，Composition API，TypeScript支持 |
| Element Plus | 成熟的企业级组件库，文档完善 |
| Vuex 4 | 状态管理，与Vue 3兼容性好 |
| Axios | HTTP客户端，拦截器支持，错误处理完善 |
| ECharts | 数据可视化，功能强大，性能优秀 |

### 后端技术选型

| 技术 | 选择理由 |
|------|----------|
| C++17 | 高性能，内存控制，企业级稳定性 |
| Boost Beast | 现代C++ HTTP库，异步支持 |
| MySQL 8.0 | 企业级数据库，JSON支持，性能优秀 |
| JWT | 无状态认证，分布式友好 |
| BCrypt | 业界标准密码哈希算法 |

---

**注意：** 本架构文档描述了系统的设计理念和实现方案，具体实现可能根据开发进度有所调整。