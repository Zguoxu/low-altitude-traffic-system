FROM ubuntu:22.04

# 避免交互式安装提示
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Shanghai

# 更新包列表并安装基础依赖
RUN apt-get update && apt-get install -y \
    # 基础工具
    curl \
    wget \
    git \
    vim \
    nano \
    unzip \
    zip \
    tree \
    htop \
    # 构建工具
    build-essential \
    cmake \
    pkg-config \
    # C++开发依赖
    gcc \
    g++ \
    gdb \
    valgrind \
    # 网络和SSL相关
    libssl-dev \
    libcurl4-openssl-dev \
    # MySQL客户端库
    libmysqlclient-dev \
    mysql-client \
    # Python (用于一些构建脚本)
    python3 \
    python3-pip \
    # 其他实用工具
    ca-certificates \
    gnupg \
    lsb-release \
    software-properties-common \
    && rm -rf /var/lib/apt/lists/*

# 安装Node.js (LTS版本)
RUN curl -fsSL https://deb.nodesource.com/setup_lts.x | bash - \
    && apt-get install -y nodejs

# 安装vcpkg包管理器
WORKDIR /opt
RUN git clone https://github.com/Microsoft/vcpkg.git \
    && cd vcpkg \
    && ./bootstrap-vcpkg.sh \
    && ./vcpkg integrate install

# 设置vcpkg环境变量
ENV VCPKG_ROOT=/opt/vcpkg
ENV PATH="$VCPKG_ROOT:$PATH"

# 预安装项目需要的vcpkg包
RUN cd /opt/vcpkg && \
    ./vcpkg install \
    httplib \
    nlohmann-json \
    openssl \
    libmysql \
    ixwebsocket

# 创建开发用户
RUN groupadd -r developer && useradd -r -g developer -m -d /home/developer -s /bin/bash developer \
    && usermod -aG sudo developer \
    && echo 'developer ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

# 创建工作目录并设置权限
WORKDIR /workspace
RUN chown -R developer:developer /workspace \
    && chown -R developer:developer /opt/vcpkg

# 切换到开发用户
USER developer

# 设置git配置
RUN git config --global --add safe.directory /workspace \
    && git config --global init.defaultBranch main

# 安装全局npm包
RUN npm install -g @vue/cli @vue/cli-service-global nodemon

# 设置shell配置
RUN echo 'export VCPKG_ROOT=/opt/vcpkg' >> ~/.bashrc \
    && echo 'export PATH="$VCPKG_ROOT:$PATH"' >> ~/.bashrc \
    && echo 'alias ll="ls -la"' >> ~/.bashrc \
    && echo 'alias la="ls -la"' >> ~/.bashrc

# 暴露端口
EXPOSE 5173 8080

# 设置工作目录
WORKDIR /workspace

# 默认命令
CMD ["bash"]